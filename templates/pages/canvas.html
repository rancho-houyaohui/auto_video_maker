<style>
    /* --- å·¦ä¾§è®¾ç½®æ  --- */
        .canvas-view .modal-body{
            display: flex;
        }
        .canvas-view .sidebar {
            width: 380px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 20;
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            padding: 0;
        }

        .canvas-view .sidebar-content {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex: 1;
        }

        .canvas-view .section {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .canvas-view .section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #4b5563;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .canvas-view .section-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 14px;
            margin-right: 8px;
            border-radius: 2px;
        }

        /* è¡¨å•æ§ä»¶ */
        .canvas-view .form-group { margin-bottom: 10px; }
        .canvas-view .label { display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 4px; }
        
        .canvas-view .input[type="text"], .canvas-view input[type="number"], select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        .canvas-view .input[type="text"]:focus, .canvas-view textarea:focus { outline: none; border-color: var(--primary-color); }

        .canvas-view .row { display: flex; gap: 10px; }
        .canvas-view .col { flex: 1; }

        .canvas-view input[type="color"] {
            width: 100%; height: 38px; padding: 2px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;
        }

        /* åº•éƒ¨æŒ‰é’®åŒº */
        .canvas-view .footer-actions {
            padding: 20px;
            background: #fff;
            border-top: 1px solid var(--border-color);
        }

        .canvas-view .btn {
            display: block; width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-size: 15px; font-weight: 600; cursor: pointer; text-align: center;
            background-color: var(--primary-color); color: white;
        }
        .canvas-view .btn:hover { opacity: 0.9; }
        .canvas-view .btn-secondary { background-color: #fff; border: 1px solid var(--border-color); color: #374151; margin-bottom: 10px; }
        .canvas-view .btn-secondary:hover { background-color: #f9fafb; }

        /* --- å³ä¾§ç”»å¸ƒåŒº --- */
        .canvas-view .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }
        
        .canvas-view .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: hidden;
        }

        .canvas-view .canvas {
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 100%;
            max-height: 100%;
            background: white;
        }

        .canvas-view .info-bar {
            padding: 8px 20px;
            background: rgba(255,255,255,0.8);
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
</style>
<div id="page-canvas" class="page-view canvas-view">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="m-0 text-white fw-light">å°é¢åˆ¶ä½œ</h4>
    </div>

    <div class="modal-dialog modal-fullscreen-lg-down"> <!-- å“åº”å¼å…¨å± -->
        <div class="modal-content">
            <div class="modal-body">
                
                <!-- ç”»å¸ƒ -->
                <div class="workspace">
                    <div class="canvas-container">
                        <canvas id="editorCanvas1"></canvas>
                    </div>
                    <div class="info-bar">
                        <span id="canvasSizeInfo1">ç”»å¸ƒå°ºå¯¸: - x -</span>
                        <span>ğŸ’¡ æç¤ºï¼šæ‹–åŠ¨æ–‡å­—é è¿‘ä¸­å¿ƒä¼šè‡ªåŠ¨å¸é™„</span>
                    </div>
                </div>

                <div class="sidebar" style="background: var(--bg-panel); color: var(--text-main);">
                    <div class="sidebar-content" style="padding: 20px;">
                        <!-- å…¨å±€è®¾ç½® -->
                        <div class="v-card">
                            <div class="section-title">åº•å›¾ä¸ç”»å¸ƒ</div>
                            <div class="form-group">
                                <label class="small text-muted mb-2 d-block">ä¸Šä¼ èƒŒæ™¯å›¾ (è‡ªåŠ¨è°ƒæ•´ç”»å¸ƒå¤§å°)</label>
                                <input type="file" class="v-input" id="bgInput1" accept="image/*">
                            </div>
                            <button class="v-btn v-btn-outline mt-2" onclick="loadDemoImage()">ğŸ² åŠ è½½æ¼”ç¤ºå›¾ç‰‡</button>
                        </div>

                        <!-- ä¸»æ ‡é¢˜è®¾ç½® -->
                        <div class="v-card">
                            <div class="section-title">ä¸»æ ‡é¢˜</div>
                            <div class="form-group">
                                <textarea class="v-input" id="mainText1" rows="2">è¿™é‡Œæ˜¯ä¸»æ ‡é¢˜æ–‡æ¡ˆ</textarea>
                            </div>
                            <div class="row g-2">
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">å­—å·</label>
                                    <input type="number" class="v-input" id="mainSize1" value="120">
                                </div>
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">å­—é‡</label>
                                    <select class="v-select" id="mainWeight1">
                                        <option value="normal">æ­£å¸¸</option>
                                        <option value="bold" selected>ç²—ä½“</option>
                                        <option value="900">è¶…ç²—</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">å­—ä½“é¢œè‰²</label>
                                    <input type="color" class="v-input p-0" style="height:38px" id="mainColor1" value="#FFFFFF">
                                </div>
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">æè¾¹é¢œè‰²</label>
                                    <input type="color" class="v-input p-0" style="height:38px" id="mainStroke1" value="#000000">
                                </div>
                            </div>
                        </div>

                        <!-- å‰¯æ ‡é¢˜è®¾ç½® -->
                        <div class="v-card">
                            <div class="section-title">å‰¯æ ‡é¢˜</div>
                            <div class="form-group">
                                <textarea class="v-input" id="subText1" rows="2">â€”â€” æ‹–åŠ¨æ–‡å­—ä¼šæœ‰ç£å¸æ•ˆæœ â€”â€”</textarea>
                            </div>
                            <div class="row g-2">
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">å­—å·</label>
                                    <input type="number" class="v-input" id="subSize1" value="60">
                                </div>
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">å­—é‡</label>
                                    <select class="v-select" id="subWeight1">
                                        <option value="normal" selected>æ­£å¸¸</option>
                                        <option value="bold">ç²—ä½“</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">å­—ä½“é¢œè‰²</label>
                                    <input type="color" class="v-input p-0" style="height:38px" id="subColor1" value="#FFD700">
                                </div>
                                <div class="col">
                                    <label class="small text-muted mb-1 d-block">æè¾¹é¢œè‰²</label>
                                    <input type="color" class="v-input p-0" style="height:38px" id="subStroke1" value="#000000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="footer-actions" style="padding: 20px; background: var(--bg-panel); border-top: 1px solid var(--border);">
                        <div class="form-group">
                            <label class="small text-muted mb-2 d-block">å¯¼å‡ºå€ç‡ (é«˜æ¸…æ”¾å¤§)</label>
                            <select class="v-select" id="exportScale1">
                                <option value="1">1x (åŸå›¾å¤§å°)</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x (è¶…æ¸…)</option>
                            </select>
                        </div>
                        <button class="v-btn mt-2" onclick="exportImage()">å¯¼å‡ºå°é¢å›¾</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ï¼ˆIIFEï¼‰é¿å…å˜é‡å†²çª
    (function() {
    // --- 1. çŠ¶æ€ç®¡ç† ---
    const layers = {
        bg: { img: null, width: 1920, height: 1080 }, // é»˜è®¤å°ºå¯¸
        main: { text: "", x: 960, y: 440, size: 120, color: "#fff", stroke: "#000", weight: "bold" },
        sub:  { text: "", x: 960, y: 640, size: 60,  color: "#FFD700", stroke: "#000", weight: "normal" }
    };

    // è¾…åŠ©çº¿çŠ¶æ€
    const guides = {
        showX: false, // æ˜¯å¦æ˜¾ç¤ºå‚ç›´ä¸­çº¿
        showY: false  // æ˜¯å¦æ˜¾ç¤ºæ°´å¹³ä¸­çº¿
    };

    const canvas = document.getElementById('editorCanvas1');
    const ctx = canvas.getContext('2d');
    let isDragging = null; 
    let dragStart = { x: 0, y: 0 };
    const SNAP_THRESHOLD = 15; // å¸é™„é˜ˆå€¼ï¼ˆåƒç´ ï¼‰

    // --- 2. åˆå§‹åŒ–ä¸ç»‘å®š ---
    function init() {
        // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
        bindInput('mainText1', 'main', 'text');
        bindInput('mainSize1', 'main', 'size', true);
        bindInput('mainColor1', 'main', 'color');
        bindInput('mainStroke1', 'main', 'stroke');
        bindInput('mainWeight1', 'main', 'weight');

        bindInput('subText1', 'sub', 'text');
        bindInput('subSize1', 'sub', 'size', true);
        bindInput('subColor1', 'sub', 'color');
        bindInput('subStroke1', 'sub', 'stroke');
        bindInput('subWeight1', 'sub', 'weight');

        document.getElementById('bgInput1').addEventListener('change', handleImageUpload);
        canvas.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);

        syncUI();
        resizeCanvas(1920, 1080);
        loadDemoImage();
    }

    function bindInput(id, layer, key, isNumber = false) {
        document.getElementById(id).addEventListener('input', (e) => {
            layers[layer][key] = isNumber ? parseInt(e.target.value) : e.target.value;
            render();
        });
    }

    function syncUI() {
        document.getElementById('mainText1').value = layers.main.text;
        document.getElementById('mainSize1').value = layers.main.size;
        document.getElementById('subText1').value = layers.sub.text;
    }

    // --- 3. æ ¸å¿ƒé€»è¾‘ï¼šå›¾ç‰‡åŠ è½½ ---
    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => createImg(evt.target.result);
        reader.readAsDataURL(file);
    }

    function createImg(src) {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            layers.bg.img = img;
            resizeCanvas(img.width, img.height);
            // é‡ç½®æ–‡å­—ä½ç½®åˆ°ä¸­å¿ƒ
            layers.main.x = img.width / 2;
            layers.main.y = img.height / 2 - 50;
            layers.sub.x = img.width / 2;
            layers.sub.y = img.height / 2 + 100;
            render();
        };
        img.src = src;
    }

    function loadDemoImage() {
        createImg("https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=1200&auto=format&fit=crop");
        layers.main.text = "2026 å‰ç«¯å…¨æ ˆå¼€å‘";
        layers.sub.text = "ä»å…¥é—¨åˆ°ç²¾é€šå®æˆ˜æŒ‡å—";
        document.getElementById('mainText1').value = layers.main.text;
        document.getElementById('subText1').value = layers.sub.text;
    }

    function resizeCanvas(w, h) {
        layers.bg.width = w;
        layers.bg.height = h;
        canvas.width = w;
        canvas.height = h;
        document.getElementById('canvasSizeInfo1').textContent = `ç”»å¸ƒå°ºå¯¸: ${w} x ${h} px`;
    }

    // --- 4. æ ¸å¿ƒé€»è¾‘ï¼šæ¸²æŸ“ (æ”¯æŒä¼ å…¥ context ä»¥ä¾¿å¯¼å‡º) ---
    function render(targetCtx = ctx, scale = 1) {
        const w = layers.bg.width;
        const h = layers.bg.height;

        targetCtx.clearRect(0, 0, w, h);

        // 1. ç»˜åˆ¶èƒŒæ™¯
        if (layers.bg.img) {
            targetCtx.drawImage(layers.bg.img, 0, 0, w, h);
        } else {
            targetCtx.fillStyle = "#eee";
            targetCtx.fillRect(0, 0, w, h);
            targetCtx.fillStyle = "#ccc";
            targetCtx.font = "30px sans-serif";
            targetCtx.textAlign = "center";
            targetCtx.fillText("è¯·ä¸Šä¼ åº•å›¾", w/2, h/2);
        }

        // 2. ç»˜åˆ¶è¾…åŠ©çº¿ (ä»…åœ¨éå¯¼å‡ºä¸”æ‹–æ‹½æ—¶æ˜¾ç¤º)
        if (targetCtx === ctx && isDragging) {
            targetCtx.save();
            targetCtx.beginPath();
            targetCtx.lineWidth = 1;
            targetCtx.strokeStyle = "#00FFFF"; // äº®é’è‰²è¾…åŠ©çº¿
            
            // å‚ç›´ä¸­çº¿
            if (guides.showX) {
                targetCtx.moveTo(w / 2, 0);
                targetCtx.lineTo(w / 2, h);
            }
            // æ°´å¹³ä¸­çº¿
            if (guides.showY) {
                targetCtx.moveTo(0, h / 2);
                targetCtx.lineTo(w, h / 2);
            }
            targetCtx.stroke();
            targetCtx.restore();
        }

        // 3. ç»˜åˆ¶æ–‡å­—å›¾å±‚å‡½æ•°
        const drawTextLayer = (layerKey) => {
            const l = layers[layerKey];
            if (!l.text) return;

            targetCtx.save();
            targetCtx.font = `${l.weight} ${l.size}px "Microsoft YaHei", sans-serif`;
            targetCtx.fillStyle = l.color;
            targetCtx.strokeStyle = l.stroke;
            targetCtx.lineWidth = l.size / 15; 
            targetCtx.textAlign = "center";
            targetCtx.textBaseline = "middle";
            targetCtx.lineJoin = "round";

            const lines = l.text.split('\n');
            const lineHeight = l.size * 1.3;
            const totalTextH = lines.length * lineHeight;
            
            lines.forEach((line, index) => {
                const lineY = l.y - (totalTextH / 2) + (index * lineHeight) + (lineHeight/2);
                targetCtx.strokeText(line, l.x, lineY);
                targetCtx.fillText(line, l.x, lineY);

                // é€‰ä¸­æ¡† (è¾…åŠ©è§†è§‰)
                if (targetCtx === ctx && isDragging === layerKey) {
                    targetCtx.lineWidth = 2;
                    targetCtx.strokeStyle = "rgba(13, 110, 253, 0.5)";
                    targetCtx.setLineDash([5, 5]);
                    const metrics = targetCtx.measureText(line);
                    targetCtx.strokeRect(l.x - metrics.width/2 - 10, lineY - l.size/2, metrics.width + 20, l.size);
                }
            });

            targetCtx.restore();
        };

        drawTextLayer('main');
        drawTextLayer('sub');
    }

    // --- 5. äº¤äº’é€»è¾‘ (å¢åŠ ç£å¸ç®—æ³•) ---
    function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (evt.clientX - rect.left) * scaleX,
            y: (evt.clientY - rect.top) * scaleY
        };
    }

    function hitTest(pos) {
        const layersToCheck = ['sub', 'main'];
        for (let key of layersToCheck) {
            const l = layers[key];
            const lines = l.text.split('\n').length;
            const h = l.size * lines * 1.2;
            // å®½æ³›çš„å‘½ä¸­åˆ¤å®š
            if (Math.abs(pos.y - l.y) < h / 2 + 20 && Math.abs(pos.x - l.x) < 500) { 
                return key;
            }
        }
        return null;
    }

    function handleMouseDown(e) {
        const pos = getMousePos(e);
        const hitLayer = hitTest(pos);
        if (hitLayer) {
            isDragging = hitLayer;
            dragStart = { x: pos.x, y: pos.y };
            canvas.style.cursor = 'grabbing';
            render(); 
        }
    }

    function handleMouseMove(e) {
        if (!isDragging) {
            const pos = getMousePos(e);
            const hit = hitTest(pos);
            canvas.style.cursor = hit ? 'grab' : 'default';
            return;
        }

        const pos = getMousePos(e);
        const dx = pos.x - dragStart.x;
        const dy = pos.y - dragStart.y;

        // è®¡ç®—æ–°åæ ‡
        let newX = layers[isDragging].x + dx;
        let newY = layers[isDragging].y + dy;

        // --- ç£å¸é€»è¾‘å¼€å§‹ ---
        const centerX = layers.bg.width / 2;
        const centerY = layers.bg.height / 2;

        // é‡ç½®è¾…åŠ©çº¿çŠ¶æ€
        guides.showX = false;
        guides.showY = false;

        // æ°´å¹³å¸é™„
        if (Math.abs(newX - centerX) < SNAP_THRESHOLD) {
            newX = centerX; // å¼ºåˆ¶å¸é™„åˆ°ä¸­å¿ƒ
            guides.showX = true; // æ˜¾ç¤ºè¾…åŠ©çº¿
        }

        // å‚ç›´å¸é™„
        if (Math.abs(newY - centerY) < SNAP_THRESHOLD) {
            newY = centerY; // å¼ºåˆ¶å¸é™„åˆ°ä¸­å¿ƒ
            guides.showY = true; // æ˜¾ç¤ºè¾…åŠ©çº¿
        }
        // --- ç£å¸é€»è¾‘ç»“æŸ ---

        // åº”ç”¨åæ ‡æ›´æ–°
        layers[isDragging].x = newX;
        layers[isDragging].y = newY;

        dragStart = { x: pos.x, y: pos.y };
        render();
    }

    function handleMouseUp() {
        if (isDragging) {
            isDragging = null;
            // æ‹–æ‹½ç»“æŸæ—¶éšè—è¾…åŠ©çº¿
            guides.showX = false;
            guides.showY = false;
            canvas.style.cursor = 'default';
            render();
        }
    }

    // --- 6. å¯¼å‡ºé€»è¾‘ ---
    function exportImage() {
        const scale = parseFloat(document.getElementById('exportScale1').value);
        const w = layers.bg.width;
        const h = layers.bg.height;

        const offCanvas = document.createElement('canvas');
        offCanvas.width = w * scale;
        offCanvas.height = h * scale;
        const offCtx = offCanvas.getContext('2d');

        offCtx.scale(scale, scale);
        // å¯¼å‡ºæ—¶ä¸æ˜¾ç¤ºè¾…åŠ©çº¿
        isDragging = null; 
        render(offCtx, scale);

        const link = document.createElement('a');
        link.download = `cover_${Date.now()}.png`;
        link.href = offCanvas.toDataURL('image/png', 1.0);
        link.click();
    }

    init();
    })();
</script>