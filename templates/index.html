<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è§†é¢‘å·¥ä½œç«™ - Ultimate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* æ ¸å¿ƒå¸ƒå±€ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .scene-card { border-left: 5px solid #0d6efd; background: #fff; margin-bottom: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s; }
        .scene-card.emphasis { border-left-color: #dc3545; background: #fff5f5; }
        .scene-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }

        /* è§†é¢‘ç¼©ç•¥å›¾ */
        .video-thumb { width: 100%; height: 90px; object-fit: cover; cursor: pointer; border-radius: 6px; background: #000; transition: border 0.2s; }
        .video-thumb:hover { border: 2px solid #0d6efd; }

        /* å­—å¹•é¢„è§ˆæ¡† */
        .preview-box {
            width: 100%; height: 120px; 
            background-color: #000;
            background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), 
                              linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #1a1a1a 75%), 
                              linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            border-radius: 6px; position: relative; overflow: hidden; border: 1px solid #444; margin-top: 10px;
        }
        .sub-layer {
            position: absolute; width: 100%; text-align: center; 
            font-family: "Microsoft YaHei", sans-serif; pointer-events: none; 
            padding: 0 10px; line-height: 1.2; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); 
            white-space: pre-wrap; 
            transition: all 0.3s;
        }

        :root { --norm-size: 16px; --norm-color: #fff; --norm-outline: #000; --emp-size: 24px; --emp-color: #f00; --emp-outline: #fff; }
        .sub-normal { bottom: 15px; font-size: var(--norm-size); color: var(--norm-color); -webkit-text-stroke: 0.5px var(--norm-outline); }
        .sub-emphasis { top: 50%; transform: translateY(-50%); font-size: var(--emp-size); font-weight: 900; color: var(--emp-color); -webkit-text-stroke: 1px var(--emp-outline); }

        /* èµ„æºåº“å¸ƒå±€ */
        .res-split-pane { display: flex; gap: 20px; height: 600px; }
        .res-left { flex: 1; border-right: 1px solid #ddd; padding-right: 15px; overflow-y: auto; }
        .res-right { flex: 1; padding-left: 5px; display: flex; flex-direction: column; }
        .res-results { flex: 1; overflow-y: auto; border: 1px dashed #ccc; border-radius: 6px; padding: 10px; background: #f9f9f9; }
        
        .log-box { background: #1e1e1e; color: #0f0; font-family: 'Consolas', monospace; padding: 15px; height: 300px; overflow-y: auto; border-radius: 4px; font-size: 13px; line-height: 1.5; }
        .hidden-item { display: none !important; }
        .video-select-item video { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .video-select-item:hover video { opacity: 0.8; }
        
        /* æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ */
        .upload-area { border: 2px dashed #0d6efd; border-radius: 8px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.2s; }
        .upload-area:hover { background: #e9ecef; border-color: #0b5ed7; }
    </style>
</head>
<body class="bg-light">

<audio id="sfxPlayer"></audio>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸ¬ AI è§†é¢‘å…¨æµç¨‹å·¥ä½œç«™ <span class="badge bg-danger">Ultimate</span></h3>
        <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">åˆ·æ–°</button>
            <a href="/projects" id="projectsLink" target="_blank"><button class="btn  btn-outline-secondary  btn-sm">ğŸ¬ è§†é¢‘é¡¹ç›®ç®¡ç†</button></a></li>
            <a href="/canvas" id="canvasLink" target="_blank"><button class="btn  btn-outline-secondary  btn-sm">ğŸ–¼ï¸ å°é¢å·¥åŠ</button></a></li>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#config-pane">âš™ï¸ å…¨å±€é…ç½®</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#style-pane">ğŸ¨ å­—å¹•æ ·å¼</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#script-pane" id="tab-script">ğŸ“ åˆ†é•œç²¾ä¿®</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#resource-pane">ğŸ“¦ èµ„æºåº“</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#history-pane" onclick="loadHistory()">ğŸ“œ å†å²è®°å½•</button></li>
        <!-- <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#upload-pane" onclick="checkLoginStatus()">ğŸš€ å‘å¸ƒä¸­å¿ƒ</button>
        </li> -->
    </ul>

    <div class="tab-content">
        
        <!-- 1. å…¨å±€é…ç½® -->
        <div class="tab-pane fade show active" id="config-pane">
            <div class="card p-4 shadow-sm border-0">
                <div class="row g-4">
                    <div class="col-md-6 border-end">
                        <h6 class="text-muted fw-bold mb-3">API å¯†é’¥è®¾ç½®</h6>
                        <input type="password" id="pexelsKey" class="form-control mb-3" placeholder="{{ 'Pexels å·²åœ¨åå°é…ç½®' if default_pexels else 'è¯·è¾“å…¥ Pexels API Key' }}" oninput="localStorage.setItem('pexelsKey', this.value)">
                        <!-- <input type="password" id="pixabayKey" class="form-control" placeholder="{{ 'Pixabay å·²åœ¨åå°é…ç½®' if default_pixabay else 'è¯·è¾“å…¥ Pixabay API Key' }}"> -->
                        <div class="form-text mt-2">æ³¨: éŸ³æ•ˆæœç´¢é»˜è®¤ä½¿ç”¨ MyInstants (æ— éœ€Key)</div>
                        <hr class="my-4">
                        <h6 class="text-muted fw-bold mb-3">ğŸ§  å¤§æ¨¡å‹è®¾ç½® (LLM)</h6>
                        <div class="mb-3">
                            <label class="form-label small">æ¨¡å‹æ¥æº</label>
                            <select id="llmProvider" class="form-select" onchange="toggleLlmSettings()">
                                <option value="ollama">æœ¬åœ° Ollama (å…è´¹/éšç§)</option>
                                <option value="api">åœ¨çº¿ API (DeepSeek/OpenAI)</option>
                            </select>
                        </div>
                        
                        <!-- Ollama è®¾ç½® -->
                        <div id="ollamaSettings">
                            <div class="mb-3">
                                <label class="form-label small">æœ¬åœ°æ¨¡å‹åç§°</label>
                                <input type="text" id="ollamaModel" class="form-control" placeholder="qwen2.5:7b" value="{{ default_llm_model }}">
                                <div class="form-text">è¯·ç¡®ä¿ç»ˆç«¯å·²è¿è¡Œ `ollama serve`</div>
                            </div>
                        </div>
                        
                        <!-- API è®¾ç½® (é»˜è®¤éšè—) -->
                        <div id="apiSettings" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label small">API Base URL</label>
                                <input type="text" id="apiBaseUrl" class="form-control" placeholder="https://api.deepseek.com" value="{{ default_api_base }}" oninput="localStorage.setItem('apiBaseUrl', this.value)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">API Key</label>
                                <input type="password" id="apiKey" class="form-control" placeholder="sk-..." oninput="localStorage.setItem('apiKey', this.value)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">æ¨¡å‹åç§° (Model ID)</label>
                                <input type="text" id="apiModel" class="form-control" placeholder="deepseek-chat" oninput="localStorage.setItem('apiModel', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted fw-bold mb-3">é»˜è®¤ç”Ÿæˆå‚æ•°</h6>
                        <div class="mb-3">
                            <label class="form-label small">èƒŒæ™¯éŸ³ä¹ (BGM)</label>
                            <select id="bgmSelect" class="form-select">
                                <option value="">(æ— èƒŒæ™¯éŸ³ä¹)</option>
                                {% for m in music %} <option value="{{m}}">ğŸµ {{m}}</option> {% endfor %}
                            </select>
                        </div>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label small">BGMéŸ³é‡</label>
                                <input type="number" id="bgmVol" class="form-control" value="0.1" step="0.1" max="1.0">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">å¥é—´åœé¡¿(ç§’)</label>
                                <input type="number" id="audioPadding" class="form-control" value="0" step="0.1">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">TTSè¯­é€Ÿ(%)</label>
                                <input type="number" id="ttsRate" class="form-control" value="10" step="5" placeholder="15">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label small">é»˜è®¤é…éŸ³è§’è‰²</label>
                            <select id="globalVoice" class="form-select">
                                {% for vid, vname in voice_options %}
                                <option value="{{vid}}" {% if vid == default_voice %}selected{% endif %}>{{vname}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å­—å¹•æ ·å¼ -->
        <div class="tab-pane fade" id="style-pane">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card border-primary p-3 h-100">
                        <h6 class="text-primary mb-3">æ™®é€šå­—å¹• (åº•éƒ¨)</h6>
                        <label class="small">å­—å· (px)</label>
                        <input type="number" id="normSize" class="form-control mb-2" value="85" oninput="updateStylePreview()">
                        <label class="small">æ–‡å­—é¢œè‰²</label>
                        <input type="color" id="normColor" class="form-control form-control-color w-100 mb-2" value="#FFFFFF" oninput="updateStylePreview()">
                        <label class="small">æè¾¹é¢œè‰²</label>
                        <input type="color" id="normOutline" class="form-control form-control-color w-100" value="#000000" oninput="updateStylePreview()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-danger p-3 h-100">
                        <h6 class="text-danger mb-3">é‡ç‚¹å­—å¹• (éœ¸å±)</h6>
                        <label class="small">å­—å· (px)</label>
                        <input type="number" id="empSize" class="form-control mb-2" value="140" oninput="updateStylePreview()">
                        <label class="small">æ–‡å­—é¢œè‰²</label>
                        <input type="color" id="empColor" class="form-control form-control-color w-100 mb-2" value="#FF0000" oninput="updateStylePreview()">
                        <label class="small">æè¾¹é¢œè‰²</label>
                        <input type="color" id="empOutline" class="form-control form-control-color w-100" value="#FFFFFF" oninput="updateStylePreview()">
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. åˆ†é•œç²¾ä¿® -->
        <div class="tab-pane fade" id="script-pane">
            <div class="card mb-4 shadow-sm" id="initCard">
                <div class="card-body">
                    <label class="fw-bold mb-2">è¾“å…¥æ–‡æ¡ˆ</label>
                    <textarea id="scriptInput" class="form-control mb-3" rows="4" placeholder="åœ¨æ­¤ç²˜è´´è§†é¢‘æ–‡æ¡ˆ...">è¿™ç»å¯¹æ˜¯2025å¹´æœ€ç–¯ç‹‚çš„é£å£ï¼å¾ˆå¤šäººæ¯å¤©éƒ½åœ¨ç„¦è™‘ï¼Œå…¶å®æ˜¯å› ä¸ºæ²¡æœ‰æŒæ¡åº•å±‚é€»è¾‘ã€‚</textarea>
                    <button onclick="analyzeScript(this)" class="btn btn-primary w-100 fw-bold py-2">ğŸ§  AI æ‹†è§£åˆ†é•œ</button>
                </div>
            </div>

            <div id="editorArea" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3 sticky-top bg-light py-2 shadow-sm px-3 rounded border" style="z-index:10; top:0;">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary" id="sceneCount">0</span>
                        <div class="btn-group">
                            <button onclick="applyGlobalVoice()" class="btn btn-sm btn-outline-secondary">åº”ç”¨å…¨å±€è¯­éŸ³</button>
                            <button onclick="applyGlobalPadding()" class="btn btn-sm btn-outline-secondary">åº”ç”¨å…¨å±€åœé¡¿</button>
                        </div>
                        <!-- [æ–°å¢] æ‰‹åŠ¨ä¿å­˜æŒ‰é’® -->
                        <button onclick="manualSave()" class="btn btn-sm btn-outline-primary" id="btnSaveProject" style="display:none;">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
                    </div>
                    <button onclick="openRenderModal()" class="btn btn-success fw-bold px-4">ğŸš€ å¼€å§‹æ¸²æŸ“</button>
                </div>
                
                <div id="scenesContainer"></div>
                
                <div class="text-center mt-5 mb-5 text-muted small">--- åˆ°åº•äº† ---</div>
            </div>
        </div>

        <!-- 4. èµ„æºåº“ (å…¨é¢å‡çº§) -->
        <div class="tab-pane fade" id="resource-pane">
            <ul class="nav nav-pills mb-3" id="resTab">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#res-video-pane">ğŸ“º è§†é¢‘ç´ æ</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#res-sfx-pane">ğŸ”Š éŸ³æ•ˆç´ æ</a></li>
                <!-- [æ–°å¢] éŸ³ä¹ Tab -->
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#res-music-pane">ğŸµ èƒŒæ™¯éŸ³ä¹</a></li>
            </ul>
            
            <div class="tab-content">
                <!-- è§†é¢‘é¢æ¿ -->
                <div class="tab-pane fade show active" id="res-video-pane">
                    <div class="res-split-pane">
                        <div class="res-left">
                            <h6 class="sticky-top bg-white py-2 border-bottom">ğŸ“‚ æœ¬åœ°å·²ä¸‹è½½</h6>
                            <input type="text" id="resLocalVideoSearch" class="form-control mb-2 form-control-sm" placeholder="ç­›é€‰æœ¬åœ°..." oninput="filterResourceVideos()">
                            <div id="resLocalGrid" class="row g-2">
                                {% for v in videos %}
                                <div class="col-6 res-item" data-name="{{v}}">
                                    <div class="card h-100">
                                        <video src="/static/video/{{v}}" class="card-img-top" style="height:80px;object-fit:cover" controls></video>
                                        <div class="card-body p-1"><div class="small text-truncate" title="{{v}}">{{v}}</div></div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="res-right">
                            <h6 class="sticky-top bg-white py-2 border-bottom text-primary">ğŸŒ åœ¨çº¿æœç´¢ (Pexels)</h6>
                            <div class="input-group mb-2">
                                <input type="text" id="resOnlineVideoInput" class="form-control form-control-sm" placeholder="è‹±æ–‡å…³é”®è¯...">
                                <button class="btn btn-primary btn-sm" onclick="searchResOnlineVideo(this)">ğŸ” æœç´¢</button>
                            </div>
                            <div id="resOnlineGrid" class="res-results">
                                <div class="text-center text-muted small mt-5">è¾“å…¥å…³é”®è¯æœç´¢é¢„è§ˆï¼Œç‚¹å‡»ä¸‹è½½å…¥åº“</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- éŸ³æ•ˆé¢æ¿ -->
                <div class="tab-pane fade" id="res-sfx-pane">
                    <div class="res-split-pane">
                        <div class="res-left">
                            <h6 class="sticky-top bg-white py-2 border-bottom">ğŸ“‚ æœ¬åœ°éŸ³æ•ˆ</h6>
                            <input type="text" id="resLocalSfxSearch" class="form-control mb-2 form-control-sm" placeholder="ç­›é€‰..." oninput="filterResourceSfx()">
                            <div class="list-group" id="resSfxList">
                                {% for s in sfx_list %}
                                <div class="list-group-item p-2 res-sfx-item" data-name="{{s}}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-2 overflow-hidden" style="max-width: 80%;">
                                            <span class="badge bg-secondary rounded-pill" style="font-size:10px">MP3</span>
                                            <span class="small text-truncate" title="{{s}}">{{s}}</span>
                                        </div>
                                        <button class="btn btn-xs btn-outline-primary rounded-circle" onclick="playSfx('{{s}}')">â–¶ï¸</button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="res-right">
                            <h6 class="sticky-top bg-white py-2 border-bottom text-success">ğŸŒ åœ¨çº¿æœç´¢ (MyInstants)</h6>
                            <div class="input-group mb-2">
                                <input type="text" id="resOnlineSfxInput" class="form-control form-control-sm" placeholder="å…³é”®è¯ (å¦‚: boom, laugh)...">
                                <button class="btn btn-success btn-sm" onclick="searchResOnlineSfx(this)">ğŸ” æœç´¢</button>
                            </div>
                            <div id="resSfxOnlineResults" class="res-results">
                                <div class="text-center text-muted small mt-5">æ— éœ€ Keyï¼Œç›´æ¥æœç´¢å¹¶ä¸‹è½½</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [æ–°å¢] éŸ³ä¹é¢æ¿ -->
                <div class="tab-pane fade" id="res-music-pane">
                    <div class="res-split-pane">
                        <div class="res-left">
                            <h6 class="sticky-top bg-white py-2 border-bottom">ğŸµ æœ¬åœ°éŸ³ä¹åº“</h6>
                            <div class="list-group" id="resMusicList">
                                {% for m in music %}
                                <div class="list-group-item p-2 d-flex justify-content-between align-items-center" id="music-item-{{loop.index}}">
                                    <span class="small">ğŸµ {{m}}</span>
                                    <div>
                                        <button class="btn btn-xs btn-outline-primary me-1" onclick="playMusic('{{m}}')">â–¶ï¸</button>
                                        <button class="btn btn-xs btn-outline-danger" onclick="deleteMusic('{{m}}', this)">ğŸ—‘ï¸</button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="res-right">
                            <h6 class="sticky-top bg-white py-2 border-bottom text-info">â¬†ï¸ ä¸Šä¼ éŸ³ä¹</h6>
                            <div class="upload-area mt-3" onclick="document.getElementById('musicFileInput').click()">
                                <h3 class="text-muted">ğŸ“‚</h3>
                                <p class="mb-0 text-muted">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ MP3/WAV æ–‡ä»¶</p>
                                <input type="file" id="musicFileInput" accept=".mp3,.wav" style="display:none" onchange="uploadMusic(this)">
                            </div>
                            <div id="uploadStatus" class="mt-3 text-center small text-muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. å†å²è®°å½• -->
        <div class="tab-pane fade" id="history-pane">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">å·²ç”Ÿæˆçš„è§†é¢‘</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="historyContainer" class="row g-4"></div>
        </div>

        <!-- 6. å‘å¸ƒ -->
        <div class="tab-pane fade" id="upload-pane">
            <div class="row">
                <!-- å·¦ä¾§ï¼šè´¦å·çŠ¶æ€ -->
                <div class="col-md-4">
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-white fw-bold">ğŸ“¡ è´¦å·è¿æ¥çŠ¶æ€</div>
                        <div class="list-group list-group-flush" id="accountList">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                            <div class="text-center py-3">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    <div class="alert alert-info small">
                        â„¹ï¸ ç‚¹å‡»â€œè¿æ¥â€ä¼šå¼¹å‡ºæµè§ˆå™¨çª—å£ï¼Œè¯·åœ¨çª—å£ä¸­æ‰«ç ç™»å½•ã€‚ç™»å½•æˆåŠŸåå…³é—­çª—å£å³å¯ã€‚
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šå‘å¸ƒæ§åˆ¶ -->
                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">ğŸ“¤ å‘å¸ƒè§†é¢‘</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©è§†é¢‘</label>
                                <select id="uploadVideoSelect" class="form-select" onchange="previewUploadVideo()">
                                    <option value="">-- è¯·é€‰æ‹©å·²ç”Ÿæˆçš„è§†é¢‘ --</option>
                                    <!-- JS åŠ¨æ€åŠ è½½å†å²è§†é¢‘ -->
                                </select>
                            </div>
                            
                            <!-- é¢„è§ˆå°çª— -->
                            <div class="mb-3 text-center bg-black rounded" style="min-height: 150px; display:none;" id="uploadPreviewBox">
                                <video id="uploadPreviewPlayer" controls style="height: 200px; max-width: 100%"></video>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">è§†é¢‘æ ‡é¢˜</label>
                                <input type="text" id="uploadTitle" class="form-control" placeholder="è¾“å…¥å¸ç›æ ‡é¢˜...">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                                <input type="text" id="uploadTags" class="form-control" placeholder="AI, ç§‘æŠ€, åˆ›ä¸š">
                            </div>
                            
                            <label class="form-label">å‘å¸ƒåˆ°å¹³å°</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-outline-dark" onclick="doPublish('douyin')">æŠ–éŸ³</button>
                                <button class="btn btn-outline-warning" onclick="doPublish('bilibili')">Bilibili</button>
                                <button class="btn btn-outline-danger" onclick="doPublish('xiaohongshu')">å°çº¢ä¹¦</button>
                                <button class="btn btn-outline-success" onclick="doPublish('video_number')">è§†é¢‘å·</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è§†é¢‘é€‰æ‹© Modal -->
<div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div class="btn-group me-3">
                    <button class="btn btn-outline-primary active" id="btnLocalView" onclick="switchVideoView('local')">ğŸ“‚ æœ¬åœ°</button>
                    <button class="btn btn-outline-primary" id="btnOnlineView" onclick="switchVideoView('online')">ğŸŒ åœ¨çº¿</button>
                </div>
                <h5 class="modal-title">é€‰æ‹©ç´ æ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="localControls" class="mb-3"><input type="text" id="localSearchInput" class="form-control" placeholder="ğŸ” ç­›é€‰..." oninput="filterLocalVideos()"></div>
                <div id="onlineControls" class="mb-3" style="display:none;">
                    <div class="input-group"><input type="text" id="onlineSearchInput" class="form-control" placeholder="Pexels è‹±æ–‡è¯..."><button class="btn btn-primary" onclick="searchOnlineVideo(this)">ğŸ”</button></div>
                </div>
                <div id="localVideoGrid" class="row g-3" style="max-height: 500px; overflow-y: auto;">
                    {% for v in videos %}
                    <div class="col-md-3 col-6 video-select-item" data-name="{{v}}">
                        <div class="card h-100 shadow-sm">
                            <video src="/static/video/{{v}}" class="card-img-top" style="height:100px; object-fit:cover" muted onmouseover="this.play()" onmouseout="this.pause()"></video>
                            <div class="card-body p-2 text-center">
                                <div class="small text-truncate mb-2" title="{{v}}">{{v}}</div>
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="selectVideo({type:'local', src:'/static/video/{{v}}', name:'{{v}}'})">âœ… é€‰æ‹©</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div id="onlineVideoGrid" class="row g-3" style="max-height: 500px; overflow-y: auto; display:none;"><div class="text-center py-5 text-muted">è¯·æœç´¢</div></div>
            </div>
        </div>
    </div>
</div>

<!-- æ¸²æŸ“è¿›åº¦ Modal -->
<div class="modal fade" id="renderModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸš€ æ¸²æŸ“æ§åˆ¶å°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="closeRenderBtn" style="display:none"></button>
            </div>
            <div class="modal-body">
                <div id="logContainer" class="log-box mb-3"></div>
                <div id="resultArea" style="display:none" class="text-center">
                    <div class="alert alert-success fw-bold">âœ… æ¸²æŸ“å®Œæˆï¼</div>
                    <video id="finalVideoPlayer" controls class="w-100 mb-3 bg-black" style="max-height: 400px; border-radius: 8px;"></video>
                    <div class="d-flex justify-content-center gap-3" id="actionBtnContainer">
                        <a id="finalDownloadBtn" href="#" class="btn btn-primary btn-lg px-4" download>ğŸ“¥ ä¸‹è½½è§†é¢‘</a>
                        <button class="btn btn-outline-secondary btn-lg px-4" data-bs-dismiss="modal">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ³¨å…¥æ•°æ® -->
<script>
    const SERVER_VOICE_OPTIONS = [{% for vid, vname in voice_options %} {id: "{{vid}}", name: "{{vname}}"}, {% endfor %}];
    const SERVER_SFX_LIST = [{% for s in sfx_list %} "{{s}}", {% endfor %}];
    const CLIENT_ID = "client_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

    // è·å–ç¯å¢ƒä¿¡æ¯
    const isFrozen = {{ is_frozen|tojson }};
    console.log("isFrozen:", isFrozen);
    // function isDesktopApp() {
    //     return window.pywebview !== undefined;
    // }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let globalScenes = [];
    let currentEditingIndex = -1;
    const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
    const renderModal = new bootstrap.Modal(document.getElementById('renderModal'));
    let ws = null;

    // --- åˆå§‹åŒ– ---
    function updateStylePreview() {
        const root = document.documentElement;
        const getVal = (id) => document.getElementById(id).value;
        root.style.setProperty('--norm-size', (getVal('normSize') * 0.25) + 'px');
        root.style.setProperty('--norm-color', getVal('normColor'));
        root.style.setProperty('--norm-outline', getVal('normOutline'));
        root.style.setProperty('--emp-size', (getVal('empSize') * 0.25) + 'px');
        root.style.setProperty('--emp-color', getVal('empColor'));
        root.style.setProperty('--emp-outline', getVal('empOutline'));
        if(globalScenes.length > 0) globalScenes.forEach((_, idx) => updatePreview(idx));
    }
    // --- åˆå§‹åŒ–é€»è¾‘ ---
    const urlParams = new URLSearchParams(window.location.search);
    const CURRENT_PROJECT_ID = urlParams.get('project_id');

    window.addEventListener('DOMContentLoaded', async () => {
        updateStylePreview();
        
        // å¦‚æœæ˜¯ç¼–è¾‘å·²æœ‰é¡¹ç›®
        if (CURRENT_PROJECT_ID) {
            console.log("æ­£åœ¨åŠ è½½é¡¹ç›®:", CURRENT_PROJECT_ID);
            
            // UI æç¤º
            const header = document.querySelector('h3');
            header.innerHTML += ` <span class="badge bg-info text-dark fs-6" style="vertical-align: middle;">æ­£åœ¨ç¼–è¾‘é¡¹ç›®: ${CURRENT_PROJECT_ID}</span>`;
            
            try {
                const res = await fetch(`/api/projects/${CURRENT_PROJECT_ID}`);
                const d = await res.json();
                
                if(d.status === 'ok') {
                    const p = d.data;
                    
                    // 1. å›å¡«æ–‡æ¡ˆ
                    if (p.script) {
                        document.getElementById('scriptInput').value = p.script;
                    }
                    
                    // 2. å›å¡«åˆ†é•œæ•°æ® (æ ¸å¿ƒä¿®å¤)
                    if (p.scenes_data && Array.isArray(p.scenes_data) && p.scenes_data.length > 0) {
                        globalScenes = p.scenes_data;
                        console.log("æ¢å¤åˆ†é•œæ•°æ®:", globalScenes.length, "æ¡");
                        
                        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                        renderScenes();
                        
                        // æ˜¾ç¤ºç¼–è¾‘å™¨åŒºåŸŸ
                        document.getElementById('editorArea').style.display = 'block';
                        
                        // è‡ªåŠ¨åˆ‡æ¢åˆ°åˆ†é•œ Tab
                        const tabEl = document.querySelector('#tab-script');
                        if (tabEl) bootstrap.Tab.getOrCreateInstance(tabEl).show();
                        
                        // æ¢å¤å…¶ä»–é…ç½® (å¦‚æœæœ‰ä¿å­˜çš„è¯ï¼Œç›®å‰ project DB ç»“æ„æš‚æœªå­˜é…ç½®ï¼Œå¯åç»­æ‰©å±•)
                    }
                } else {
                    alert("é¡¹ç›®åŠ è½½å¤±è´¥: " + d.msg);
                }
            } catch(e) { 
                console.error("Project load error", e); 
                alert("æ— æ³•è¿æ¥æœåŠ¡å™¨è·å–é¡¹ç›®æ•°æ®");
            }
        }
    });

    // é¡µé¢åŠ è½½æ—¶åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
    if (CURRENT_PROJECT_ID) {
        document.getElementById('btnSaveProject').style.display = 'inline-block';
    }

    async function manualSave() {
        const btn = document.getElementById('btnSaveProject');
        const oldText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;
        
        await autoSaveProject();
        
        setTimeout(() => {
            btn.innerText = "âœ… å·²ä¿å­˜";
            setTimeout(() => {
                btn.innerText = oldText;
                btn.disabled = false;
            }, 1000);
        }, 500);
    }

    // --- éŸ³æ•ˆ/éŸ³ä¹æ’­æ”¾ ---
    function playSfx(filename) {
        if (!filename) return;
        const player = document.getElementById('sfxPlayer');
        player.src = `/static/sfx/${filename}`;
        player.volume = 0.5;
        player.play().catch(e => console.log("Blocked"));
    }
    function playMusic(filename) {
        if (!filename) return;
        const player = document.getElementById('sfxPlayer');
        player.src = `/static/music/${filename}`;
        player.volume = 0.5;
        player.play().catch(e => console.log("Blocked"));
    }

    // --- éŸ³ä¹ä¸Šä¼ ä¸åˆ é™¤ ---
    async function uploadMusic(input) {
        if(!input.files || !input.files[0]) return;
        const file = input.files[0];
        const status = document.getElementById('uploadStatus');
        
        const formData = new FormData();
        formData.append('file', file);
        
        status.innerHTML = '<span class="text-primary">â³ ä¸Šä¼ ä¸­...</span>';
        
        try {
            const res = await fetch('/api/music/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if(data.status === 'ok') {
                status.innerHTML = '<span class="text-success">âœ… ä¸Šä¼ æˆåŠŸ</span>';
                
                // åˆ·æ–°éŸ³ä¹åˆ—è¡¨ UI (ç®€å•åšæ³•ï¼šåˆ·æ–°é¡µé¢)
                // æˆ–è€…æ‰‹åŠ¨æ’å…¥ DOM
                setTimeout(() => location.reload(), 1000);
            } else {
                status.innerHTML = `<span class="text-danger">âŒ ${data.msg}</span>`;
            }
        } catch(e) {
            status.innerHTML = `<span class="text-danger">âŒ Error: ${e}</span>`;
        }
    }
    
    async function deleteMusic(filename, btn) {
        if(!confirm(`åˆ é™¤ ${filename}?`)) return;
        try {
            const res = await fetch(`/api/music/${filename}`, {method: 'DELETE'});
            if(res.ok) {
                btn.closest('.list-group-item').remove();
                // åˆ·æ–°ä¸‹æ‹‰æ¡†
                const select = document.getElementById('bgmSelect');
                for (let i=0; i<select.options.length; i++) {
                    if (select.options[i].value === filename) select.remove(i);
                }
            } else alert("å¤±è´¥");
        } catch(e) { alert("Err: "+e); }
    }

    function toggleLlmSettings() {
        const provider = document.getElementById('llmProvider').value;
        document.getElementById('ollamaSettings').style.display = provider === 'ollama' ? 'block' : 'none';
        document.getElementById('apiSettings').style.display = provider === 'api' ? 'block' : 'none';

        // ä¿å­˜ LLM è®¾ç½®
        document.getElementById('pexelsKey').value = localStorage.getItem('pexelsKey') || '';
        document.getElementById('apiBaseUrl').value = localStorage.getItem('apiBaseUrl') || '';
        document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
        document.getElementById('apiModel').value = localStorage.getItem('apiModel') || '';

    }
    
    // åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡
    toggleLlmSettings();

    // --- AI åˆ†æ ---
    async function analyzeScript(btn) {
        const text = document.getElementById('scriptInput').value;
        const pexels = document.getElementById('pexelsKey').value;
        // const pixabay = document.getElementById('pixabayKey').value;
        const pixabay = '';


        // è·å– LLM å‚æ•°
        const provider = document.getElementById('llmProvider').value;
        let llmModel = "";
        let llmBase = "";
        let llmKey = "";
        
        if (provider === 'ollama') {
            llmModel = document.getElementById('ollamaModel').value;
        } else {
            llmModel = document.getElementById('apiModel').value;
            llmBase = document.getElementById('apiBaseUrl').value;
            llmKey = document.getElementById('apiKey').value;
        }
        
        if(!text.trim()) { alert("è¯·è¾“å…¥æ–‡æ¡ˆ"); return; }

        btn.disabled = true; 
        const oldText = "ğŸ§  AI æ‹†è§£åˆ†é•œ";
        const states = ["è¿æ¥å¤§æ¨¡å‹...", "åˆ†æè¯­ä¹‰...", "æå–å…³é”®è¯...", "åŒ¹é…éŸ³æ•ˆ...", "ç”Ÿæˆæ•°æ®..."];
        let sIdx = 0;
        const interval = setInterval(() => { btn.innerText = states[sIdx++ % states.length]; }, 2500);

        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    text, 
                    pexels_key: pexels, 
                    pixabay_key: pixabay,
                    llm_provider: provider,
                    llm_model: llmModel,
                    llm_base_url: llmBase,
                    llm_api_key: llmKey
                })
            });

            const rawText = await res.text();
            let data;
            try {
                data = JSON.parse(rawText);
            } catch(e) {
                // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜åç«¯å´©äº†ï¼Œç›´æ¥å¼¹çª—æ˜¾ç¤ºåç«¯æŠ¥é”™å †æ ˆ
                alert("åç«¯ä¸¥é‡é”™è¯¯ (500):\n" + rawText.substring(0, 500)); // æˆªå–å‰500å­—
                throw new Error("JSON Parse Error");
            }
            
            if(data.status !== "ok") throw new Error("Analysis failed");
            
            globalScenes = data.scenes;
            
            // æ³¨å…¥é»˜è®¤å€¼
            const defPad = document.getElementById('audioPadding').value;
            const globalVoice = document.getElementById('globalVoice').value;
            
            globalScenes.forEach(s => {
                s.audio_padding = defPad;
                s.voice = globalVoice;
            });
            
            renderScenes();
            document.getElementById('editorArea').style.display = 'block';
            
            // åˆ‡æ¢åˆ° Tab
            const tabEl = document.querySelector('#tab-script');
            if (tabEl) bootstrap.Tab.getOrCreateInstance(tabEl).show();

            // ã€æ–°å¢ã€‘åˆ†æå®Œæˆåï¼Œè‡ªåŠ¨ä¿å­˜åˆ†é•œåˆ°é¡¹ç›®
            if (CURRENT_PROJECT_ID) {
                await autoSaveProject();
            }
            
        } catch(e) {
            alert("API Error: " + e);
        } finally {
            clearInterval(interval);
            btn.disabled = false;
            btn.innerText = oldText;
        }
    }

    // --- æ¸²æŸ“åˆ†é•œåˆ—è¡¨ ---
    function renderScenes() {
        const container = document.getElementById('scenesContainer');
        const countBadge = document.getElementById('sceneCount');
        
        if(!container) return;
        
        container.innerHTML = '';
        if(countBadge) countBadge.innerText = globalScenes.length;
        
        globalScenes.forEach((scene, idx) => {
            const isEmp = scene.is_emphasis ? 'emphasis' : '';
            const checkEmp = scene.is_emphasis ? 'checked' : '';
            
            // è§†é¢‘å±•ç¤ºé€»è¾‘
            let vInfo = scene.video_info || {type: 'local', src: '', name: 'æœªé€‰æ‹©'};
            // å…¼å®¹æ—§æ ¼å¼
            if (scene.video && !scene.video_info) {
               if(scene.video.startsWith('http')) vInfo = {type: 'online', src: scene.video, name: 'åœ¨çº¿ç´ æ'};
               else vInfo = {type: 'local', src: `/static/video/${scene.video}`, name: scene.video};
            }
            if (scene.video === 'random') vInfo = {type: 'local', src: '', name: 'éšæœºç´ æ'};

            let mediaHtml = '';
            
            if (vInfo.type === 'missing') {
                // [æ–°å¢] ç¼ºå¤±ç´ æçš„æ ·å¼ï¼šçº¢è‰²è¾¹æ¡† + æç¤ºç‚¹å‡»
                mediaHtml = `
                    <div class="video-thumb d-flex flex-column align-items-center justify-content-center bg-light border border-danger text-danger" 
                         style="cursor:pointer; height:90px;">
                        <span style="font-size:20px">âš ï¸</span>
                        <span class="small" style="font-size:10px">ç‚¹å‡»é€‰æ‹©ç´ æ</span>
                    </div>
                `;
            } else if (vInfo.src) {
                // æ­£å¸¸è§†é¢‘
                mediaHtml = `<video src="${vInfo.src}" class="video-thumb" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`;
            } else {
                // éšæœº/æœªçŸ¥
                mediaHtml = `<div class="video-thumb d-flex align-items-center justify-content-center text-secondary bg-light border small">éšæœºç´ æ</div>`;
            }
            
            let nameDisplay = vInfo.type === 'online' ? `ğŸŒ ${vInfo.tags || 'Pexels'}` : vInfo.name;

            // æ„é€ ä¸‹æ‹‰é¡¹
            let voiceHtml = SERVER_VOICE_OPTIONS.map(opt => 
                `<option value="${opt.id}" ${opt.id === scene.voice ? 'selected' : ''}>${opt.name}</option>`
            ).join('');

            let sfxHtml = `<option value="">(æ— )</option>`;
            SERVER_SFX_LIST.forEach(s => {
                sfxHtml += `<option value="${s}" ${scene.sfx_search && s.includes(scene.sfx_search) ? 'selected' : ''}>${s}</option>`;
            });
            if (scene.sfx_search && !SERVER_SFX_LIST.some(s => s.includes(scene.sfx_search))) {
                sfxHtml += `<option value="${scene.sfx_search}" selected>ğŸ” ${scene.sfx_search}</option>`;
            }

            const tagsStr = (scene.visual_tags || []).join(', ');

            const html = `
            <div class="scene-card ${isEmp}" id="card-${idx}">
                <div class="row">
                    <!-- å·¦ä¾§ï¼šç¼–è¾‘ -->
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-secondary">#${idx+1}</span>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-danger btn-sm py-0" onclick="deleteScene(${idx})">ğŸ—‘ï¸</button>
                                <button class="btn btn-outline-success btn-sm py-0" onclick="splitScene(${idx})">âœ‚ï¸</button>
                            </div>
                        </div>
                        <div class="mb-2">
                            <textarea id="text-${idx}" class="form-control" rows="2" 
                                oninput="updateScene(${idx}, 'text', this.value); updatePreview(${idx})">${scene.text}</textarea>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">é‡ç‚¹è¯</span>
                                    <input type="text" class="form-control" value="${scene.keywords || ''}" 
                                        oninput="updateScene(${idx}, 'keywords', this.value); updatePreview(${idx})">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-warning bg-opacity-10">ç”»é¢(è‹±)</span>
                                    <input type="text" class="form-control" value="${tagsStr}" onchange="updateTags(${idx}, this.value)">
                                </div>
                            </div>
                            
                            <div class="col-4">
                                <select class="form-select form-select-sm" onchange="updateScene(${idx}, 'voice', this.value)">${voiceHtml}</select>
                            </div>
                            <div class="col-4">
                                <select class="form-select form-select-sm" onchange="updateScene(${idx}, 'sfx_search', this.value); playSfx(this.value)">${sfxHtml}</select>
                            </div>
                            <div class="col-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">åœé¡¿</span>
                                    <input type="number" class="form-control" value="${scene.audio_padding || 0.2}" step="0.1" 
                                        onchange="updateScene(${idx}, 'audio_padding', this.value)">
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input" type="checkbox" ${checkEmp} 
                                        onchange="updateScene(${idx}, 'is_emphasis', this.checked); updatePreview(${idx})">
                                    <label class="form-check-label small fw-bold">é‡ç‚¹éœ¸å±æ¨¡å¼</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šé¢„è§ˆ -->
                    <div class="col-md-4">
                        <div onclick="openVideoModal(${idx})" class="position-relative" style="cursor:pointer" title="ç‚¹å‡»æ›´æ¢è§†é¢‘">
                            ${mediaHtml}
                            <div class="position-absolute bottom-0 start-0 bg-dark text-white px-1 small opacity-75 text-truncate" style="max-width:100%">${nameDisplay}</div>
                        </div>
                        
                        <div class="preview-box mt-2" id="preview-${idx}">
                            <div class="sub-layer" id="subtext-${idx}"></div>
                        </div>
                        <div class="text-center mt-1"><small class="text-muted" style="font-size:10px">å­—å¹•æ ·å¼é¢„è§ˆ</small></div>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            updatePreview(idx);
        });
    }

    function updateScene(idx, field, value) {
        globalScenes[idx][field] = value;
        if(field === 'is_emphasis') {
            const card = document.getElementById(`card-${idx}`);
            value ? card.classList.add('emphasis') : card.classList.remove('emphasis');
        }
        updatePreview(idx);
    }
    
    function updateTags(idx, str) {
        globalScenes[idx].visual_tags = str.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean);
    }

    function updatePreview(idx) {
        const scene = globalScenes[idx];
        const subDiv = document.getElementById(`subtext-${idx}`);
        if (!subDiv) return;
        
        const empColor = document.getElementById('empColor').value;
        const normColor = document.getElementById('normColor').value;
        
        let fullText = scene.text || "";
        fullText = fullText.replace(/[\(ï¼ˆ].*?[\)ï¼‰]/g, '').trim();
        
        let rawKw = scene.keywords;
        if (Array.isArray(rawKw)) rawKw = rawKw.join(", ");
        const keywordsStr = String(rawKw || "").trim();
        
        if (scene.is_emphasis) {
            subDiv.className = 'sub-layer sub-emphasis';
            subDiv.style.color = empColor; 
            subDiv.innerHTML = fullText; 
        } else {
            subDiv.className = 'sub-layer sub-normal';
            subDiv.style.color = normColor;
            if (keywordsStr) {
                let keywords = keywordsStr.split(/[,ï¼Œ]/).map(k => k.trim()).filter(Boolean);
                keywords.sort((a, b) => b.length - a.length);
                let htmlText = fullText;
                keywords.forEach(kw => {
                    if (kw && htmlText.includes(kw)) {
                        const regex = new RegExp(kw, 'g');
                        const span = `<span style="color: ${empColor}; font-weight: bold; -webkit-text-stroke: 0px;">${kw}</span>`;
                        htmlText = htmlText.replace(regex, span);
                    }
                });
                subDiv.innerHTML = htmlText;
            } else {
                subDiv.innerText = fullText;
            }
        }
    }

    function splitScene(idx) {
        const textarea = document.getElementById(`text-${idx}`);
        const cursor = textarea.selectionStart;
        const text = globalScenes[idx].text;
        const part1 = text.substring(0, cursor).trim();
        const part2 = text.substring(cursor).trim();
        
        if(!part1 || !part2) return alert("è¯·å°†å…‰æ ‡æ”¾åœ¨æ–‡å­—ä¸­é—´");
        
        globalScenes[idx].text = part1;
        const newScene = JSON.parse(JSON.stringify(globalScenes[idx]));
        newScene.text = part2;
        newScene.keywords = ""; 
        globalScenes.splice(idx + 1, 0, newScene);
        renderScenes();
    }
    
    function deleteScene(idx) {
        if(confirm("ç¡®å®šåˆ é™¤?")) { globalScenes.splice(idx, 1); renderScenes(); }
    }
    
    function applyGlobalVoice() {
        const v = document.getElementById('globalVoice').value;
        globalScenes.forEach(s => s.voice = v);
        renderScenes();
    }
    
    function applyGlobalPadding() {
        const p = document.getElementById('audioPadding').value;
        globalScenes.forEach(s => s.audio_padding = p);
        renderScenes();
    }

    // --- è§†é¢‘é€‰æ‹© ---
    function openVideoModal(idx) {
        currentEditingIndex = idx;
        const scene = globalScenes[idx];
        switchVideoView('local');
        if(scene.visual_tags && scene.visual_tags.length > 0) {
            document.getElementById('onlineSearchInput').value = scene.visual_tags[0];
        } else {
            document.getElementById('onlineSearchInput').value = '';
        }
        document.getElementById('localSearchInput').value = '';
        filterLocalVideos();
        videoModal.show();
    }
    
    function switchVideoView(mode) {
        const localGrid = document.getElementById('localVideoGrid');
        const onlineGrid = document.getElementById('onlineVideoGrid');
        const localCtrl = document.getElementById('localControls');
        const onlineCtrl = document.getElementById('onlineControls');
        const btnLocal = document.getElementById('btnLocalView');
        const btnOnline = document.getElementById('btnOnlineView');

        if (mode === 'local') {
            localGrid.style.display = 'flex'; onlineGrid.style.display = 'none';
            localCtrl.style.display = 'block'; onlineCtrl.style.display = 'none';
            btnLocal.classList.add('active'); btnOnline.classList.remove('active');
        } else {
            localGrid.style.display = 'none'; onlineGrid.style.display = 'flex';
            localCtrl.style.display = 'none'; onlineCtrl.style.display = 'block';
            btnLocal.classList.remove('active'); btnOnline.classList.add('active');
        }
    }

    function selectVideo(videoObj) {
        globalScenes[currentEditingIndex].video_info = videoObj;
        globalScenes[currentEditingIndex].video = videoObj.name;
        renderScenes();
        videoModal.hide();
    }
    
    function filterLocalVideos() { 
        const term = document.getElementById('localSearchInput').value.toLowerCase(); 
        document.querySelectorAll('.video-select-item').forEach(el => {
            if (el.parentElement.id === 'localVideoGrid') {
                el.classList.toggle('hidden-item', !el.getAttribute('data-name').toLowerCase().includes(term));
            }
        }); 
    }
    function filterResourceVideos() {
        const term = document.getElementById('resLocalVideoSearch').value.toLowerCase();
        document.querySelectorAll('.res-item').forEach(el => el.classList.toggle('hidden-item', !el.getAttribute('data-name').toLowerCase().includes(term)));
    }
    function filterResourceSfx() {
        const term = document.getElementById('resLocalSfxSearch').value.toLowerCase();
        document.querySelectorAll('.res-sfx-item').forEach(el => el.classList.toggle('hidden-item', !el.getAttribute('data-name').toLowerCase().includes(term)));
    }
    
    async function searchOnlineVideo(btn) {
        const q = document.getElementById('onlineSearchInput').value;
        const k = document.getElementById('pexelsKey').value;
        if(!q) return; btn.disabled=true; btn.innerText="..";
        const grid = document.getElementById('onlineVideoGrid');
        grid.innerHTML = '<div class="text-center py-5">â³...</div>';
        switchVideoView('online');

        try {
            const res = await fetch(`/api/search_online?query=${q}&pexels_key=${k}`, {method:'POST'});
            const d = await res.json();
            if(d.status === 'ok') {
                grid.innerHTML = '';
                if(d.results.length === 0) grid.innerHTML = '<div class="text-center py-5">æ— ç»“æœ</div>';
                else {
                    d.results.forEach(v => {
                        const vStr = JSON.stringify(v).replace(/"/g, '&quot;');
                        const safeTag = (v.tags||"").replace(/"/g,"");
                        const div = document.createElement('div');
                        div.className = 'col-md-3 col-6 video-select-item';
                        div.innerHTML = `
                            <div class="card h-100 shadow-sm border-0">
                                <video src="${v.src}" class="card-img-top" style="height:100px;object-fit:cover" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>
                                <div class="card-body p-2 text-center">
                                    <div class="small text-muted mb-2 text-truncate">ID:${v.id}</div>
                                    <div class="d-grid gap-1">
                                        <button class="btn btn-sm btn-outline-success" onclick='selectVideo(${vStr})'>ğŸ‘ï¸ é¢„è§ˆ</button>
                                        <button class="btn btn-sm btn-primary" onclick='downloadAndSelect(this, "${v.download_url}", "${v.id}", "${safeTag}")'>â¬‡ï¸ ä¸‹è½½é€‰</button>
                                    </div>
                                </div>
                            </div>`;
                        grid.appendChild(div);
                    });
                }
            } else grid.innerHTML = `<div class="text-danger py-5">Error: ${d.msg}</div>`;
        } catch(e) { grid.innerHTML = `<div class="text-danger">Err:${e}</div>`; }
        finally { btn.disabled = false; btn.innerText = "ğŸ”"; }
    }
    
    async function downloadAndSelect(btn, url, id, tags) {
        const oldText = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'â³';
        try {
            const res = await fetch('/api/download_specific', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({url,id:String(id),tags})
            });
            const d = await res.json();
            if(d.status === 'ok') {
                const fname = d.filename; const vidObj = {type:'local', src:`/static/video/${fname}`, name:fname};
                const localGrid = document.getElementById('localVideoGrid');
                const div = document.createElement('div'); div.className = 'col-md-3 col-6 video-select-item text-center'; div.setAttribute('data-name', fname);
                div.innerHTML = `<div class="card h-100 shadow-sm border-success"><video src="/static/video/${fname}" class="card-img-top" style="height:100px;object-fit:cover" muted onmouseover="this.play()" onmouseout="this.pause()"></video><div class="card-body p-2 text-center"><div class="small text-truncate mb-2 text-success fw-bold">${fname}</div><button class="btn btn-sm btn-outline-primary w-100" onclick='selectVideo(${JSON.stringify(vidObj)})'>âœ… é€‰æ‹©</button></div></div>`;
                localGrid.prepend(div);
                selectVideo(vidObj); switchVideoView('local');
            } else alert("å¤±è´¥: "+d.msg);
        } catch(e) { alert("Err:"+e); }
        finally { btn.disabled = false; btn.innerHTML = oldText; }
    }

    // --- èµ„æºåº“åŠŸèƒ½ ---
    async function searchResOnlineVideo(btn) {
        const q = document.getElementById('resOnlineVideoInput').value;
        const k = document.getElementById('pexelsKey').value;
        if(!q) return; btn.disabled=true; btn.innerText="..";
        
        try {
            const res = await fetch(`/api/search_online?query=${q}&pexels_key=${k}`, {method:'POST'});
            const d = await res.json();
            const grid = document.getElementById('resOnlineGrid');
            grid.innerHTML = '';
            
            if(d.status==='ok' && d.results.length > 0) {
                d.results.forEach(v => {
                    const safeTag = (v.tags||"").replace(/"/g,"");
                    const div = document.createElement('div');
                    div.className = 'col-12 mb-2 p-2 border rounded bg-white shadow-sm';
                    div.innerHTML = `
                        <div class="d-flex gap-2 align-items-center">
                            <video src="${v.src}" style="width:100px;height:60px;object-fit:cover;border-radius:4px" muted onmouseover="this.play()" onmouseout="this.pause()"></video>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="small text-truncate fw-bold">ID: ${v.id}</div>
                                <div class="small text-muted text-truncate">${v.tags}</div>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick='downloadResVideo(this, "${v.download_url}", "${v.id}", "${safeTag}")'>â¬‡ï¸ å…¥åº“</button>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            } else alert("æœªæ‰¾åˆ°");
        } catch(e) { alert("Err: "+e); }
        finally { btn.disabled=false; btn.innerText="ğŸ” æœç´¢"; }
    }
    
    async function downloadResVideo(btn, url, id, tags) {
        btn.disabled=true; btn.innerText="â³";
        try {
            const res = await fetch('/api/download_specific', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({url,id:String(id),tags})
            });
            const d = await res.json();
            if(d.status==='ok') {
                btn.className = "btn btn-sm btn-success"; btn.innerText = "âœ…";
                const grid = document.getElementById('resLocalGrid');
                const div = document.createElement('div'); div.className = 'col-md-3 col-6 res-item'; div.setAttribute('data-name', d.filename);
                div.innerHTML = `<div class="card res-card h-100 border-success"><video src="/static/video/${d.filename}" class="card-img-top" style="height:120px;object-fit:cover" controls></video><div class="card-body p-2"><div class="small text-truncate mb-1">${d.filename}</div><span class="badge bg-success">NEW</span></div></div>`;
                grid.prepend(div);
            } else alert("Fail");
        } catch(e) { alert("Err:"+e); }
        finally { if(btn.innerText!=="âœ…") { btn.disabled=false; btn.innerText="â¬‡ï¸"; } }
    }
    
    async function searchResOnlineSfx(btn) {
        const q = document.getElementById('resOnlineSfxInput').value;
        if(!q) return; btn.disabled=true; btn.innerText="..";
        const container = document.getElementById('resSfxOnlineResults');
        container.innerHTML = '<div class="text-center py-5 text-muted">Searching MyInstants...</div>';
        
        try {
            const res = await fetch(`/api/search_sfx?query=${q}`, {method:'POST'});
            const d = await res.json();
            if(d.status === 'ok') {
                container.innerHTML = '';
                if(d.results.length === 0) container.innerHTML = '<div class="text-center py-5">No Results</div>';
                else {
                    d.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'card mb-2 shadow-sm border-0';
                        div.innerHTML = `
                            <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                <div class="text-truncate me-2" style="max-width: 50%;">
                                    <div class="fw-bold small">${item.name}</div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="previewOnlineSfx('${item.preview_url}')">â–¶ï¸ è¯•å¬</button>
                                    <button class="btn btn-sm btn-success" onclick="downloadSfxFromUrl(this, '${item.name}', '${item.download_url}')">â¬‡ï¸ å…¥åº“</button>
                                </div>
                            </div>`;
                        container.appendChild(div);
                    });
                }
            } else container.innerHTML=`<div class="text-danger p-3">${d.msg}</div>`;
        } catch(e) { container.innerHTML=`<div class="text-danger p-3">${e}</div>`; }
        finally { btn.disabled=false; btn.innerText="ğŸ” æœç´¢"; }
    }
    
    function previewOnlineSfx(url) {
        const player = document.getElementById('sfxPlayer');
        player.src = url; player.volume = 0.5;
        player.play().catch(e => alert("Play error: "+e));
    }
    
    async function downloadSfxFromUrl(btn, name, url) {
        btn.disabled=true; btn.innerText="â³";
        try {
            const safeName = name.replace(/[^a-zA-Z0-9 ]/g, "").replace(/\s+/g, "_");
            const res = await fetch('/api/download_sfx', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({query:safeName, url:url})
            });
            const d = await res.json();
            if(d.status==='ok') {
                btn.className = "btn btn-sm btn-outline-success"; btn.innerText = "âœ…";
                const list = document.getElementById('resSfxList');
                const div = document.createElement('div');
                div.className = "list-group-item p-2 res-sfx-item border-success animate__animated animate__flash";
                div.setAttribute('data-name', d.filename);
                div.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div class="d-flex align-items-center gap-2 overflow-hidden"><span class="badge bg-success rounded-pill">NEW</span><span class="small text-truncate">${d.filename}</span></div><button class="btn btn-xs btn-outline-primary rounded-circle" onclick="playSfx('${d.filename}')">â–¶ï¸</button></div>`;
                list.prepend(div);
            } else alert("Fail: "+d.msg);
        } catch(e) { alert("Err: "+e); }
        finally { if(btn.innerText!=="âœ…") btn.disabled=false; }
    }

    async function loadHistory() {
        const container = document.getElementById('historyContainer');
        container.innerHTML = '<div class="text-center py-5">Loading...</div>';
        try {
            const res = await fetch('/api/history');
            const data = await res.json();
            if (data.history.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            container.innerHTML = '';
            data.history.forEach(item => {
                let editBtn = '';
                if(item.has_project) {
                    editBtn = `<button class="btn btn-sm btn-warning me-2" onclick="loadProject('${item.json_file}')">âœï¸ ç¼–è¾‘</button>`;
                }
                let actionBtnHtml = '';
            
                if (isFrozen) {
                    // æ¡Œé¢ç‰ˆï¼šæ˜¾ç¤ºâ€œæ‰“å¼€ä½ç½®â€æŒ‰é’®
                    actionBtnHtml = `<button class="btn btn-sm btn-info text-white" onclick="openFileLocation('${item.url}')">ğŸ“‚ ä½ç½®</button>`;
                } else {
                    // ç½‘é¡µç‰ˆï¼šæ˜¾ç¤ºâ€œä¸‹è½½â€é“¾æ¥
                    actionBtnHtml = `<a href="${item.url}" class="btn btn-sm btn-primary" download>ğŸ“¥ ä¸‹è½½</a>`;
                }
                
                const html = `
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <video src="${item.url}" class="card-img-top" style="height:150px; object-fit:cover" controls></video>
                        <div class="card-body">
                            <h6 class="card-title text-truncate" title="${item.name}">${item.name}</h6>
                            <p class="card-text small text-muted">Time: ${item.time}</p>
                            <div class="d-flex justify-content-between">
                                <div>
                                    ${editBtn}
                                    ${actionBtnHtml}
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory('${item.name}', this)">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        } catch(e) { container.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; }
    }

    async function openFileLocation(url) {
        try {
            await fetch('/api/system/reveal', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: url})
            });
        } catch(e) { alert("æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹: " + e); }
    }

    async function deleteHistory(filename, btn) {
        if(!confirm(`ç¡®å®šæ°¸ä¹…åˆ é™¤ ${filename} (åŠå·¥ç¨‹æ–‡ä»¶)?`)) return;
        try {
            const res = await fetch(`/api/history/${filename}`, {method: 'DELETE'});
            if(res.ok) btn.closest('.col-md-4').remove();
            else alert("åˆ é™¤å¤±è´¥");
        } catch(e) { alert("Error: " + e); }
    }

    // --- åŠ è½½æ—§é¡¹ç›® (æ ¸å¿ƒæ–°å¢) ---
    async function loadProject(jsonFile) {
        try {
            const res = await fetch(`/api/history/load/${jsonFile}`);
            const data = await res.json();
            if(data.status !== 'ok') throw new Error("Load failed");
            
            const params = data.data;
            globalScenes = params.scenes;
            
            // æ¢å¤é…ç½®
            if(params.bgm_file) document.getElementById('bgmSelect').value = params.bgm_file;
            if(params.bgm_volume) document.getElementById('bgmVol').value = params.bgm_volume;
            if(params.audio_padding) document.getElementById('audioPadding').value = params.audio_padding;
            if(params.tts_rate) document.getElementById('ttsRate').value = params.tts_rate.replace(/[+%]/g, '');
            
            // æ¢å¤å­—å¹•æ ·å¼ (å¦‚æœæœ‰)
            if(params.subtitle_style) {
               // è¿™é‡Œç•¥å»ç¹ççš„ DOM èµ‹å€¼ï¼Œå› ä¸ºæœ‰é»˜è®¤å€¼å…œåº•
            }

            renderScenes();
            document.getElementById('editorArea').style.display = 'block';
            
            // åˆ‡æ¢ Tab
            bootstrap.Tab.getOrCreateInstance(document.getElementById('tab-script')).show();
            
        } catch(e) { alert("åŠ è½½å¤±è´¥: " + e); }
    }

    async function openRenderModal() {
        const logBox = document.getElementById('logContainer');
        const resultArea = document.getElementById('resultArea');
        const closeBtn = document.getElementById('closeRenderBtn');
        const player = document.getElementById('finalVideoPlayer');
        
        if (!logBox || !resultArea || !closeBtn) { alert("DOM Error"); return; }
        
        logBox.innerHTML = '<div class="text-muted small">Initializing...</div>';
        logBox.style.display = 'block'; resultArea.style.display = 'none'; closeBtn.style.display = 'none';
        player.src = "";
        
        renderModal.show();
        
        // å¯åŠ¨è¯·æ±‚
        startRenderRequest();
    }
    
    function appendLog(text, color) {
        const box = document.getElementById('logContainer'); if(!box) return;
        
        // æ£€æŸ¥æœ€åä¸€è¡Œï¼Œå¦‚æœæ˜¯åŒæ ·çš„è¿›åº¦ä¿¡æ¯ï¼Œç›´æ¥æ›´æ–°ï¼Œä¸è¦åˆ·å±
        const last = box.lastElementChild;
        if (last && last.innerText.startsWith("â³") && text.startsWith("â³")) {
            last.innerText = text;
            return;
        }

        const p = document.createElement('div'); 
        p.innerText = text; 
        if(color) p.style.color=color;
        box.appendChild(p); 
        box.scrollTop=box.scrollHeight;
    }
    
    async function startRenderRequest() {
        const style = {
            normal: { size: document.getElementById('normSize').value, color: document.getElementById('normColor').value, outline: document.getElementById('normOutline').value },
            emphasis: { size: document.getElementById('empSize').value, color: document.getElementById('empColor').value, outline: document.getElementById('empOutline').value }
        };
        const rateVal = document.getElementById('ttsRate').value;
        const payload = {
            client_id: CLIENT_ID, // å”¯ä¸€IDç”¨äºè½®è¯¢
            scenes: globalScenes, 
            output_name: "final_" + Date.now(),
            bgm_file: document.getElementById('bgmSelect').value, 
            bgm_volume: parseFloat(document.getElementById('bgmVol').value),
            audio_padding: parseFloat(document.getElementById('audioPadding').value), 
            tts_rate: (rateVal>=0?"+":"")+rateVal+"%", 
            subtitle_style: style
        };
        
        try { 
            const res = await fetch('/api/render', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); 
            const rawText = await res.text(); // å…ˆæ‹¿æ–‡æœ¬ï¼Œä¸è¦ç›´æ¥ .json()
            console.log("Server Response:", rawText); 

            let data;
            try { data = JSON.parse(rawText); } 
            catch(e) { 
                appendLog("âŒ ä¸¥é‡é”™è¯¯: " + rawText.substring(0, 200), "red");
                return;
            }
            
            if (data.status === "started") {
                // å¼€å§‹è½®è¯¢
                pollProgress(CLIENT_ID);
            } else {
                appendLog("Error: " + JSON.stringify(data), "red");
            }
        } catch(e) { appendLog("API Error: "+e, "red"); }
    }

    function pollProgress(cid) {
        let lastMsg = "";
        
        const timer = setInterval(async () => {
            try {
                const res = await fetch(`/api/progress/${cid}`);
                const data = await res.json();
                
                // æœ‰æ–°æ¶ˆæ¯æ‰æ‰“å°
                if (data.msg && data.msg !== lastMsg) {
                    let color = "#fff";
                    if (data.msg.includes("âœ…")) color = "#51cf66";
                    else if (data.msg.includes("âŒ")) color = "#ff6b6b";
                    else if (data.msg.includes("MoviePy") || data.msg.includes("FFmpeg")) color = "#888";
                    
                    appendLog(data.msg, color);
                    lastMsg = data.msg;
                }
                
                if (data.status === "completed") {
                    clearInterval(timer);
                    setTimeout(() => showResult(data.url), 500);
                } else if (data.status === "error") {
                    clearInterval(timer);
                    document.getElementById('closeRenderBtn').style.display = 'block';
                }
                
            } catch(e) {
                console.log("Poll error", e);
            }
        }, 1000); // æ¯ç§’æŸ¥ä¸€æ¬¡
    }
    
    function showResult(url) {
        document.getElementById('logContainer').style.display='none';
        document.getElementById('resultArea').style.display='block';
        document.getElementById('closeRenderBtn').style.display='block';
        const p = document.getElementById('finalVideoPlayer');
        const uniqueUrl = url + "?t=" + new Date().getTime();
        p.src = uniqueUrl; p.load();

        if(isFrozen){
            // æ¡Œé¢åº”ç”¨æ‰“å¼€æ–‡ä»¶ä½ç½®
            console.log("æ¡Œé¢åº”ç”¨æ‰“å¼€æ–‡ä»¶ä½ç½®:", url);
            const _html = document.getElementById('actionBtnContainer');
            if(_html) _html.innerHTML = `
                <button id="openDownloadFileLocationBtn" class="btn btn-sm btn-info text-white" onclick="openFileLocation('${url}')">ğŸ“‚ è§†é¢‘ä½ç½®</button>
                <button class="btn btn-outline-secondary btn-lg px-4" data-bs-dismiss="modal">å…³é—­</button>
            `;
            return
        }

        // è®¾ç½®ä¸‹è½½æŒ‰é’®
        const downloadBtn = document.getElementById('finalDownloadBtn');
        downloadBtn.href = uniqueUrl;
        
        // ç¡®ä¿ä¸‹è½½åŠŸèƒ½åœ¨æ‰€æœ‰ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ
        downloadBtn.onclick = function(e) {
            e.preventDefault();
            
            // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = uniqueUrl;
            a.download = uniqueUrl.split('/').pop().split('?')[0]; // ä»URLä¸­æå–æ–‡ä»¶å
            // è·¨æµè§ˆå™¨å…¼å®¹å¤„ç†
            if (typeof a.click === 'function') {
                // æ ‡å‡†æµè§ˆå™¨
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else if (typeof window.navigator.msSaveBlob === 'function') {
                // IE/Edge å…¼å®¹æ€§
                fetch(uniqueUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        const fileName = uniqueUrl.split('/').pop().split('?')[0];
                        window.navigator.msSaveBlob(blob, fileName);
                    });
            } else {
                // é™çº§æ–¹æ¡ˆ - æ‰“å¼€ä¸‹è½½é“¾æ¥
                window.open(uniqueUrl, '_blank');
            }
        };
    }
    
    // --- é¡¹ç›®è‡ªåŠ¨ä¿å­˜é€»è¾‘ ---
    async function autoSaveProject(status = null) {
        if (!CURRENT_PROJECT_ID) return; // å¦‚æœä¸æ˜¯é¡¹ç›®æ¨¡å¼ï¼Œä¸ä¿å­˜
        
        const payload = {
            script: document.getElementById('scriptInput').value,
            scenes_data: globalScenes // ä¿å­˜å½“å‰åˆ†é•œçŠ¶æ€
        };
        
        // å¦‚æœä¼ å…¥äº†çŠ¶æ€å˜æ›´ (å¦‚ 'generated')ï¼Œåˆ™æ›´æ–°çŠ¶æ€
        if (status) {
            payload.status = status;
        }

        try {
            await fetch(`/api/projects/${CURRENT_PROJECT_ID}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            console.log("é¡¹ç›®è‡ªåŠ¨ä¿å­˜æˆåŠŸ");
        } catch(e) {
            console.error("è‡ªåŠ¨ä¿å­˜å¤±è´¥:", e);
        }
    }

    // / --- å‘å¸ƒä¸­å¿ƒé€»è¾‘ ---/
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkLoginStatus() {
        const res = await fetch('/api/upload/status');
        const data = await res.json();
        const list = document.getElementById('accountList');
        list.innerHTML = '';
        
        const names = {
            "douyin": "æŠ–éŸ³ (Douyin)",
            "bilibili": "å“”å“©å“”å“© (Bilibili)",
            "video_number": "å¾®ä¿¡è§†é¢‘å·",
            "xiaohongshu": "å°çº¢ä¹¦",
            "kuaishou": "å¿«æ‰‹"
        };
        
        for (const [key, isLogged] of Object.entries(data.data)) {
            const statusHtml = isLogged 
                ? `<span class="badge bg-success">å·²è¿æ¥</span>` 
                : `<button class="btn btn-sm btn-outline-primary" onclick="loginPlatform('${key}')">è¿æ¥</button>`;
            
            const item = `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>${names[key] || key}</span>
                <div>${statusHtml}</div>
            </div>`;
            list.insertAdjacentHTML('beforeend', item);
        }
        
        // åŒæ—¶åŠ è½½è§†é¢‘åˆ—è¡¨ä¾›é€‰æ‹©
        loadUploadVideoOptions();
    }
    
    async function loginPlatform(platform) {
        // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å¹¶æ”¹å˜çŠ¶æ€
        // è¿™é‡Œéœ€è¦é‡æ–°æ¸²æŸ“åˆ—è¡¨æ¯”è¾ƒç®€å•
        
        alert("æµè§ˆå™¨çª—å£å³å°†å¼¹å‡ºã€‚\nè¯·æ‰«ç ç™»å½•ï¼ŒæˆåŠŸåã€æ‰‹åŠ¨å…³é—­çª—å£ã€‘ä»¥ä¿å­˜çŠ¶æ€ã€‚");
        
        try {
            const res = await fetch('/api/upload/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({platform})
            });
            const d = await res.json();
            
            if(d.status === 'ok') {
                alert("âœ… ç™»å½•æˆåŠŸï¼çŠ¶æ€å·²æ›´æ–°ã€‚");
                // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºâ€œå·²è¿æ¥â€
                checkLoginStatus(); 
            } else {
                alert("ç™»å½•å¤±è´¥: " + d.msg);
            }
        } catch(e) { 
            alert("API Error: " + e); 
        }
    }
    
    // åŠ è½½å¯å‘å¸ƒçš„é¡¹ç›® (çŠ¶æ€ä¸º generated)
    async function loadUploadVideoOptions() {
        const res = await fetch('/api/projects');
        const d = await res.json();
        const select = document.getElementById('uploadVideoSelect');
        select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¾…å‘å¸ƒé¡¹ç›® --</option>';
        
        // è¿‡æ»¤å‡º status == 'generated' æˆ– 'published' (æ”¯æŒé‡å‘)
        const validProjects = d.data.filter(p => p.status === 'generated' || p.status === 'published');
        
        if (validProjects.length === 0) {
            select.innerHTML = '<option value="">(æš‚æ— å·²ç”Ÿæˆçš„é¡¹ç›®)</option>';
            return;
        }

        validProjects.forEach(p => {
            const opt = document.createElement('option');
            // Value å­˜ Project IDï¼Œè€Œä¸æ˜¯è§†é¢‘è·¯å¾„
            opt.value = p.id; 
            // Data å­˜è§†é¢‘è·¯å¾„ç”¨äºé¢„è§ˆ
            opt.setAttribute('data-url', p.video_path);
            opt.setAttribute('data-title', p.title);
            
            let statusMark = p.status === 'published' ? 'ã€å·²å‘ã€‘' : 'ã€å¾…å‘ã€‘';
            opt.innerText = `${statusMark} ${p.title}`;
            select.appendChild(opt);
        });
    }
    
    function previewUploadVideo() {
        const select = document.getElementById('uploadVideoSelect');
        const selectedOpt = select.options[select.selectedIndex];
        
        const url = selectedOpt.getAttribute('data-url');
        const title = selectedOpt.getAttribute('data-title');
        
        const box = document.getElementById('uploadPreviewBox');
        const player = document.getElementById('uploadPreviewPlayer');
        
        // è‡ªåŠ¨å¡«å…¥æ ‡é¢˜
        if (title) {
            document.getElementById('uploadTitle').value = title;
        }

        if(url) {
            box.style.display = 'block';
            player.src = url;
        } else {
            box.style.display = 'none';
        }
    }
    
    async function doPublish(platform) {
        const projectId = document.getElementById('uploadVideoSelect').value;
        const title = document.getElementById('uploadTitle').value;
        const tags = document.getElementById('uploadTags').value;
        
        if(!projectId) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®");
        if(!title) return alert("è¯·å¡«å†™æ ‡é¢˜");
        
        if(!confirm(`ç¡®è®¤å‘å¸ƒåˆ°ã€${platform}ã€‘å—ï¼Ÿ`)) return;
        
        // ç¡®ä¿ WebSocket æ˜¯è¿æ¥çŠ¶æ€ï¼Œä»¥ä¾¿æ¥æ”¶æŠ¥é”™
        if(!ws || ws.readyState !== WebSocket.OPEN) {
             ws = new WebSocket(`ws://${location.host}/ws/logs/${CLIENT_ID}`);
        }

        const allBtns = document.querySelectorAll('#upload-pane button');
        allBtns.forEach(b => b.disabled = true);
        
        try {
            const res = await fetch('/api/upload/publish', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    platform: platform,
                    project_id: projectId,
                    title: title,
                    tags: tags,
                    client_id: CLIENT_ID // [æ–°å¢] ä¼ ç»™åç«¯
                })
            });
            const d = await res.json();
            if(d.status === 'started') {
                // ä¸å¼¹ Alert äº†ï¼Œç›´æ¥çœ‹æ—¥å¿—æ¡†æˆ–è€…çŠ¶æ€æ 
                // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æŠŠ RenderModal å€Ÿç”¨è¿‡æ¥æ˜¾ç¤ºå‘å¸ƒæ—¥å¿—
                // è¿™é‡Œç®€å•å¤„ç†ï¼š
                console.log("å‘å¸ƒä»»åŠ¡å·²å¯åŠ¨");
            } else {
                alert("å¯åŠ¨å¤±è´¥: " + d.msg);
            }
        } catch(e) { 
            alert("API Error: " + e); 
        } finally {
            allBtns.forEach(b => b.disabled = false);
        }
    }

    // é“¾æ¥ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
    async function handleLinkClick(event, targetUrl) {
        console.log("ç‚¹å‡»é“¾æ¥:", targetUrl, isFrozen);
        if (isFrozen) {
            // æ‰“åŒ…ç¯å¢ƒï¼šåœ¨å½“å‰çª—å£æ‰“å¼€
            await fetch('/api/open/win', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: targetUrl, title: event.target.innerText})
            });
        }
        // å¼€å‘ç¯å¢ƒï¼šä¿æŒåŸè¡Œä¸ºï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
        else {
            event.preventDefault();
            window.open(targetUrl, '_blank');
        }
    }

    // --- å…¨å±€æ¶ˆæ¯ç›‘å¬ (ç”¨äºå‘å¸ƒä¸­å¿ƒæŠ¥é”™) ---
    function initGlobalWS() {
        const socket = new WebSocket(`ws://${location.host}/ws/logs/${CLIENT_ID}`);
        socket.onmessage = (e) => {
            const msg = e.data;
            
            // 1. å¤„ç†è®¤è¯è¿‡æœŸä¿¡å·
            if (msg.includes("AUTH_EXPIRED@@@")) {
                const parts = msg.split("@@@");
                const platform = parts[1];
                
                // æ’­æ”¾ä¸€ä¸ªæç¤ºéŸ³ï¼ˆå¯é€‰ï¼‰
                // alert ä¸å¤ªå¥½ï¼Œç”¨ confirm å¼•å¯¼ç”¨æˆ·
                if(confirm(`âš ï¸ ã€${platform}ã€‘ç™»å½•å·²è¿‡æœŸï¼\nCookie å·²è‡ªåŠ¨æ¸…ç†ã€‚\n\næ˜¯å¦ç«‹å³é‡æ–°æ‰«ç ç™»å½•ï¼Ÿ`)) {
                    loginPlatform(platform);
                }
                
                // åˆ·æ–°çŠ¶æ€åˆ—è¡¨ (æŠŠ"å·²è¿æ¥"å˜æˆ"è¿æ¥")
                checkLoginStatus();
            }
            
            // 2. å¤„ç†å‘å¸ƒæˆåŠŸä¿¡å·
            if (msg.includes("å‘å¸ƒæˆåŠŸ")) {
                alert(msg); // ç®€å•å¼¹çª—æç¤º
                checkLoginStatus(); // åˆ·æ–°å¯èƒ½çš„çŠ¶æ€
            }
        };
    }
    
    // é¡µé¢åŠ è½½åå¯åŠ¨å…¨å±€ç›‘å¬
    window.addEventListener('DOMContentLoaded', () => {
        updateStylePreview();
        initGlobalWS(); // [æ–°å¢]
        
        // ä¸ºé“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        const projectsLink = document.getElementById('projectsLink');
        const canvasLink = document.getElementById('canvasLink');
        
        if (projectsLink) {
            projectsLink.addEventListener('click', function(event) {
                event.preventDefault();
                handleLinkClick(event, this.getAttribute('href'));
            });
        }
        
        if (canvasLink) {
            canvasLink.addEventListener('click', function(event) {
                event.preventDefault();
                handleLinkClick(event, this.getAttribute('href'));
            });
        }
    });
</script>
</body>
</html>