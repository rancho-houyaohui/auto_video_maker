<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®ç®¡ç† - AI è§†é¢‘å·¥ä½œç«™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .table-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); overflow: hidden; }
        .status-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; }
        .status-draft { background-color: #e2e3e5; color: #383d41; }
        .status-generated { background-color: #cff4fc; color: #055160; }
        .status-published { background-color: #d1e7dd; color: #0f5132; }
        .action-btn { margin-right: 5px; }
        .cover-preview { width: 60px; height: 34px; object-fit: cover; border-radius: 4px; background: #eee; cursor: pointer; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ğŸ¬ è§†é¢‘é¡¹ç›®ç®¡ç†</a>
        <div class="d-flex">
            <a href="/" class="btn btn-outline-light btn-sm me-2">Go to ç¼–è¾‘å™¨</a>
            <button class="btn btn-primary btn-sm" onclick="openCreateModal()">+ æ–°å»ºé¡¹ç›®</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="table-card p-4">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>å°é¢</th>
                    <th style="width: 20%">æ ‡é¢˜</th>
                    <th style="width: 30%">æ–‡æ¡ˆæ‘˜è¦</th>
                    <th>çŠ¶æ€</th>
                    <th>æˆç‰‡</th>
                    <th>å‘å¸ƒæ—¶é—´</th>
                    <th class="text-end">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="projectList">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
    </div>
</div>

<!-- æ–°å»º/ç¼–è¾‘ Modal -->
<div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°å»ºé¡¹ç›®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <div class="mb-3">
                    <label class="form-label">è§†é¢‘æ ‡é¢˜</label>
                    <input type="text" id="pTitle" class="form-control" placeholder="ä¾‹å¦‚ï¼š2025 AI é£å£">
                </div>
                <div class="mb-3">
                    <label class="form-label">æ–‡æ¡ˆè„šæœ¬</label>
                    <textarea id="pScript" class="form-control" rows="5" placeholder="è¾“å…¥å®Œæ•´æ–‡æ¡ˆ..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">è®¡åˆ’å‘å¸ƒæ—¶é—´</label>
                    <input type="datetime-local" id="pTime" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- å‘å¸ƒ Modal -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸš€ ä¸€é”®å‘å¸ƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>å°†è§†é¢‘å‘å¸ƒåˆ°ä»¥ä¸‹å¹³å° (éœ€å…ˆå»"å‘å¸ƒä¸­å¿ƒ"ç™»å½•):</p>
                <input type="hidden" id="pubPid">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-dark" onclick="doPublish('douyin')">æŠ–éŸ³</button>
                    <button class="btn btn-outline-danger" onclick="doPublish('xiaohongshu')">å°çº¢ä¹¦</button>
                    <button class="btn btn-outline-warning" onclick="doPublish('bilibili')">Bilibili</button>
                    <button class="btn btn-outline-success" onclick="doPublish('video_number')">è§†é¢‘å·</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const modal = new bootstrap.Modal(document.getElementById('projectModal'));
    const pubModal = new bootstrap.Modal(document.getElementById('publishModal'));

    document.addEventListener('DOMContentLoaded', loadProjects);

    async function loadProjects() {
        const res = await fetch('/api/projects');
        const d = await res.json();
        const tbody = document.getElementById('projectList');
        tbody.innerHTML = '';
        
        d.data.forEach(p => {
            let statusBadge = `<span class="badge status-draft">è‰ç¨¿</span>`;
            if (p.status === 'generated') statusBadge = `<span class="badge status-generated">å·²ç”Ÿæˆ</span>`;
            if (p.status === 'published') statusBadge = `<span class="badge status-published">å·²å‘å¸ƒ</span>`;
            
            const isLocked = p.status === 'published';
            const videoLink = p.video_path ? `<a href="${p.video_path}" target="_blank" class="btn btn-xs btn-link">æŸ¥çœ‹</a>` : '-';
            
            // å°é¢å›¾é€»è¾‘ (å¦‚æœç”Ÿæˆäº†è§†é¢‘ï¼Œå°è¯•æ‰¾åŒåå°é¢ï¼Œæˆ–è€…é»˜è®¤å›¾)
            const coverSrc = p.cover_path || "https://placehold.co/60x34?text=Cover";
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${coverSrc}" class="cover-preview"></td>
                <td class="fw-bold">${p.title}</td>
                <td class="text-truncate" style="max-width: 200px;">${p.script}</td>
                <td>${statusBadge}</td>
                <td>${videoLink}</td>
                <td>${p.publish_time ? p.publish_time.replace('T', ' ') : '-'}</td>
                <td class="text-end">
                    ${!isLocked ? `
                        <button class="btn btn-sm btn-outline-primary action-btn" onclick="goToEditor('${p.id}')">âœ‚ï¸ åˆ¶ä½œ/åˆ†é•œ</button>
                        <button class="btn btn-sm btn-outline-secondary action-btn" onclick="editProject('${p.id}')">âœï¸</button>
                    ` : ''}
                    
                    ${p.status === 'generated' ? `
                        <button class="btn btn-sm btn-success action-btn" onclick="openPublish('${p.id}')">ğŸ“¤ å‘å¸ƒ</button>
                    ` : ''}
                    
                    <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteProject('${p.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openCreateModal() {
        document.getElementById('pId').value = '';
        document.getElementById('pTitle').value = '';
        document.getElementById('pScript').value = '';
        document.getElementById('pTime').value = '';
        document.getElementById('modalTitle').innerText = "æ–°å»ºé¡¹ç›®";
        modal.show();
    }

    async function editProject(pid) {
        const res = await fetch(`/api/projects/${pid}`);
        const d = await res.json();
        if(d.status === 'ok') {
            document.getElementById('pId').value = d.data.id;
            document.getElementById('pTitle').value = d.data.title;
            document.getElementById('pScript').value = d.data.script;
            document.getElementById('pTime').value = d.data.publish_time;
            document.getElementById('modalTitle').innerText = "ç¼–è¾‘é¡¹ç›®";
            modal.show();
        }
    }

    async function saveProject() {
        const pid = document.getElementById('pId').value;
        const payload = {
            title: document.getElementById('pTitle').value,
            script: document.getElementById('pScript').value,
            publish_time: document.getElementById('pTime').value
        };
        
        let url = '/api/projects';
        let method = 'POST';
        
        if (pid) {
            url = `/api/projects/${pid}`;
            method = 'PUT';
        }
        
        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (res.ok) {
            modal.hide();
            loadProjects();
        } else {
            alert("ä¿å­˜å¤±è´¥");
        }
    }

    async function deleteProject(pid) {
        if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
        await fetch(`/api/projects/${pid}`, {method: 'DELETE'});
        loadProjects();
    }

    // æ ¸å¿ƒè·³è½¬é€»è¾‘ï¼šå¸¦IDè·³è½¬åˆ° index.html
    function goToEditor(pid) {
        window.location.href = `/?project_id=${pid}`;
    }

    function openPublish(pid) {
        document.getElementById('pubPid').value = pid;
        pubModal.show();
    }

    async function doPublish(platform) {
        const pid = document.getElementById('pubPid').value;
        if(!confirm(`ç¡®è®¤å‘å¸ƒåˆ° ${platform}?`)) return;
        
        const res = await fetch(`/api/projects/${pid}/publish_now`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({platform: platform})
        });
        const d = await res.json();
        if(d.status === 'started') {
            alert("âœ… å‘å¸ƒä»»åŠ¡å·²æäº¤åå°ï¼");
            pubModal.hide();
            loadProjects();
        } else {
            alert("âŒ å‘å¸ƒå¤±è´¥: " + d.msg);
        }
    }
</script>
</body>
</html>