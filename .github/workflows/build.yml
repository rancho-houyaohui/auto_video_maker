name: Build Desktop App

on:
  # 触发条件 1: 推送 tag 时自动触发
  push:
    tags:
      - 'v*'
  # 触发条件 2: 允许手动点击按钮触发 (这一行必须存在且缩进正确，按钮才会出现)
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            ffmpeg_url: https://evermeet.cx/ffmpeg/getrelease/zip
            ffmpeg_bin: ffmpeg
            asset_name: AI_Video_Station_Mac
          - os: windows-latest
            ffmpeg_url: https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip
            ffmpeg_bin: ffmpeg.exe
            asset_name: AI_Video_Station_Win

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller pywebview gradio_client

      # Mac FFmpeg 设置
      - name: Setup FFmpeg (Mac)
        if: runner.os == 'macOS'
        run: |
          mkdir -p bin
          curl -L -o ffmpeg.zip "${{ matrix.ffmpeg_url }}"
          unzip -o ffmpeg.zip
          mv ffmpeg bin/ffmpeg
          chmod +x bin/ffmpeg
          rm ffmpeg.zip

      # Windows FFmpeg 设置 (修复了 curl 问题)
      - name: Setup FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bin
          & curl.exe -L -o ffmpeg.zip "${{ matrix.ffmpeg_url }}"
          7z x ffmpeg.zip
          Move-Item -Path ffmpeg-*-win64-gpl\bin\ffmpeg.exe -Destination bin\ffmpeg.exe -Force
          Remove-Item ffmpeg.zip
          Remove-Item -Path ffmpeg-*-win64-gpl -Recurse -Force

      - name: Build with PyInstaller
        run: |
          pyinstaller AI_Video_Station.spec --clean --noconfirm
        # --- 新增步骤：手动打包 Mac 应用 ---
      - name: Zip App (Mac)
        if: runner.os == 'macOS'
        run: |
          cd dist
          # 使用 -r 保留目录结构，-y 保留符号链接和权限
          zip -r -y AI_Video_Station_Mac.zip AI_Video_Station.app

      # --- 修改上传步骤 ---
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            dist/*.exe
            dist/*.zip